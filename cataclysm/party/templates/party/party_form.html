{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<link rel="stylesheet" href="/static/css/sci-fi-form.css">
<div class="lcars-panel">
  <div class="sci-fi-form-container">
  <div class="lcars-heading" style="justify-content:center;">
    <span class="chip lcars-tab"></span>
    <h1 style="margin:0; font-size:2.2rem;">{% if party %}Edit Party{% else %}Add Party{% endif %}</h1>
  </div>
  <form method="post">
    {% csrf_token %}
    <div class="sci-fi-form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2.5em 3em; align-items: start;">
      <div class="sci-fi-form-section" style="grid-column: 1 / span 2;">
        {{ form.name|as_crispy_field }}
        {{ form.type|as_crispy_field }}
        {{ form.leader|as_crispy_field }}
        {{ form.faction|as_crispy_field }}
        {{ form.location|as_crispy_field }}
        {{ form.purpose|as_crispy_field }}
        {{ form.hidden|as_crispy_field }}
      </div>

      <div class="sci-fi-form-section" style="grid-column: 3;">
  <label class="lcars-tab" style="display:inline-block; padding:.4rem .8rem;">Members</label>
        <div style="display:flex; gap:12px; flex-direction:column;">
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="flex:1;">
              <div style="font-size:0.9rem; color:var(--lcars-accent, #9ef); margin-bottom:6px;">Available</div>
              <select id="available_members" multiple size="10" style="width:100%;">
                {% for person in people_list %}
                  {% if person.pk not in selected_member_ids %}
                    <option value="{{ person.pk }}">{{ person.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; align-items:center;">
              <button type="button" class="btn btn-secondary" onclick="moveSelected('available_members','selected_members')">&gt;&gt;</button>
              <button type="button" class="btn btn-secondary" onclick="moveSelected('selected_members','available_members')">&lt;&lt;</button>
            </div>
            <div style="flex:1;">
              <div style="font-size:0.9rem; color:var(--lcars-accent, #9ef); margin-bottom:6px;">Selected</div>
              <!-- name must be members to submit to the ModelMultipleChoiceField -->
              <select id="selected_members" name="members" multiple size="10" style="width:100%;">
                {% for person in people_list %}
                  {% if person.pk in selected_member_ids %}
                    <option value="{{ person.pk }}" selected>{{ person.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top: 2.5em;">
      <button type="submit" class="btn btn-primary lcars-btn">Engage</button>
    </div>
  </form>

  <script>
    function moveSelected(fromId, toId){
      const from = document.getElementById(fromId);
      const to = document.getElementById(toId);
      const selected = Array.from(from.options).filter(o => o.selected);
      selected.forEach(o => {
        // clone option into target and remove from source
        const newOpt = document.createElement('option');
        newOpt.value = o.value;
        newOpt.text = o.text;
        newOpt.selected = true;
        to.appendChild(newOpt);
        from.removeChild(o);
      });
    }

    // Ensure all options in selected_members are selected before submit
    document.querySelector('form').addEventListener('submit', function(e){
      const sel = document.getElementById('selected_members');
      if(sel){
        Array.from(sel.options).forEach(o => o.selected = true);
      }
    });
  </script>
  </div>
</div>
{% endblock %}
